# 实施计划

- [x] 1. 设置项目结构和类型定义



  - 在 `src/types.ts` 中添加语音聊天相关的类型定义
  - 创建 `src/hooks/useSpeechRecognition.ts` 文件骨架
  - 创建 `src/hooks/useSpeechSynthesis.ts` 文件骨架
  - 创建 `src/hooks/useVoiceChat.ts` 文件骨架
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 2. 实现 useSpeechRecognition Hook




  - [x] 2.1 实现浏览器支持检测和基础状态管理


    - 检测 SpeechRecognition API 支持
    - 初始化状态（isListening, transcript, error）
    - 实现 startListening 和 stopListening 方法
    - _需求: 1.1, 5.2_

  - [x] 2.2 实现语音识别核心逻辑


    - 配置 SpeechRecognition 实例（语言、连续模式等）
    - 处理 onresult 事件（识别结果）
    - 处理 onerror 事件（错误处理）
    - 实现静默超时自动停止逻辑
    - _需求: 1.3, 1.4, 1.5_

  - [ ]* 2.3 编写 useSpeechRecognition 的属性测试
    - **属性 1: 语音输入触发录音**
    - **验证: 需求 1.1**

  - [ ]* 2.4 编写 useSpeechRecognition 的属性测试
    - **属性 3: 静默自动停止**
    - **验证: 需求 1.3**

  - [ ]* 2.5 编写 useSpeechRecognition 的属性测试
    - **属性 4: 识别结果显示**
    - **验证: 需求 1.4**

  - [ ]* 2.6 编写 useSpeechRecognition 的单元测试
    - 测试浏览器支持检测
    - 测试开始/停止监听
    - 测试错误处理（权限拒绝、不支持）
    - _需求: 1.1, 1.3, 1.4, 1.5, 5.1, 5.2_

- [x] 3. 实现 useSpeechSynthesis Hook





  - [x] 3.1 实现浏览器支持检测和语音列表加载


    - 检测 SpeechSynthesis API 支持
    - 加载可用语音列表
    - 优先选择中文语音
    - 初始化状态（isSpeaking, isPaused, voices）
    - _需求: 2.1, 5.3_

  - [x] 3.2 实现语音合成核心逻辑


    - 实现 speak 方法（创建 SpeechSynthesisUtterance）
    - 实现 pause、resume、stop 方法
    - 处理播放完成事件
    - 实现长文本分段播放
    - _需求: 2.1, 2.3, 2.5_

  - [x] 3.3 实现语音设置管理


    - 实现 updateSettings 方法
    - 应用语速、音调、音量设置
    - 支持语音选择
    - _需求: 6.1, 6.2, 6.3, 6.4_

  - [ ]* 3.4 编写 useSpeechSynthesis 的属性测试
    - **属性 6: 自动语音播放**
    - **验证: 需求 2.1, 2.4**

  - [ ]* 3.5 编写 useSpeechSynthesis 的属性测试
    - **属性 8: 停止播放立即生效**
    - **验证: 需求 2.3**

  - [ ]* 3.6 编写 useSpeechSynthesis 的属性测试
    - **属性 13: 设置立即应用**
    - **验证: 需求 6.4**

  - [ ]* 3.7 编写 useSpeechSynthesis 的单元测试
    - 测试浏览器支持检测
    - 测试语音列表加载
    - 测试播放/暂停/停止
    - 测试设置应用
    - _需求: 2.1, 2.3, 2.5, 5.3, 6.1, 6.2, 6.3, 6.4_

- [x] 4. 实现 useVoiceChat Hook




  - [x] 4.1 实现设置持久化逻辑


    - 定义默认设置
    - 从 localStorage 加载设置
    - 实现 updateSettings 方法并保存到 localStorage
    - _需求: 3.3, 3.4, 3.5, 6.5_

  - [x] 4.2 整合语音识别和合成功能

    - 集成 useSpeechRecognition
    - 集成 useSpeechSynthesis
    - 实现统一的错误处理
    - 协调识别和合成状态
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5_

  - [x] 4.3 实现自动发送和语音输出控制

    - 根据 autoSend 设置决定是否自动发送
    - 根据 voiceOutputEnabled 控制语音播放
    - 实现条件逻辑
    - _需求: 2.4, 3.1, 3.2_

  - [ ]* 4.4 编写 useVoiceChat 的属性测试
    - **属性 10: 设置持久化往返**
    - **验证: 需求 3.3, 3.4, 3.5, 6.5**

  - [ ]* 4.5 编写 useVoiceChat 的单元测试
    - 测试设置持久化和恢复
    - 测试语音识别和合成的协调
    - 测试自动发送逻辑
    - 测试错误统一处理
    - _需求: 3.3, 3.4, 3.5, 6.5_

- [x] 5. 检查点 - 确保所有 Hooks 测试通过



  - 确保所有测试通过，如有问题请询问用户

- [x] 6. 创建 VoiceButton 组件





  - [x] 6.1 实现 VoiceButton 组件基础结构


    - 创建 `src/components/VoiceButton.tsx`
    - 实现不同状态的按钮样式（默认、监听中、禁用）
    - 添加麦克风图标
    - 实现点击事件处理
    - _需求: 1.1, 3.1, 4.1_

  - [x] 6.2 添加监听状态动画


    - 实现脉动动画效果
    - 根据 isListening 状态切换样式
    - _需求: 1.2, 4.1_

  - [ ]* 6.3 编写 VoiceButton 的属性测试
    - **属性 2: 监听状态视觉反馈**
    - **验证: 需求 1.2, 4.1**

  - [ ]* 6.4 编写 VoiceButton 的单元测试
    - 测试不同状态的渲染
    - 测试点击事件
    - 测试禁用状态
    - _需求: 1.1, 1.2, 3.1, 4.1_

- [x] 7. 创建 VoiceIndicator 组件




  - [x] 7.1 实现 VoiceIndicator 组件


    - 创建 `src/components/VoiceIndicator.tsx`
    - 显示监听状态（临时识别文本 + 波形动画）
    - 显示播放状态（"正在播放..." + 音频波形）
    - 显示处理状态（加载指示器）
    - _需求: 1.2, 2.2, 4.1, 4.2, 4.3_

  - [x] 7.2 实现状态视觉区分


    - 为不同状态使用不同的颜色和图标
    - 实现动画效果
    - _需求: 4.5_

  - [ ]* 7.3 编写 VoiceIndicator 的属性测试
    - **属性 7: 播放状态视觉反馈**
    - **验证: 需求 2.2, 4.3**

  - [ ]* 7.4 编写 VoiceIndicator 的属性测试
    - **属性 11: 处理状态视觉反馈**
    - **验证: 需求 4.2**

  - [ ]* 7.5 编写 VoiceIndicator 的属性测试
    - **属性 12: 状态视觉区分**
    - **验证: 需求 4.5**

  - [ ]* 7.6 编写 VoiceIndicator 的单元测试
    - 测试不同状态的渲染
    - 测试动画显示
    - 测试状态切换
    - _需求: 1.2, 2.2, 4.1, 4.2, 4.3, 4.5_


- [x] 8. 创建 VoiceSettings 组件（可选设置面板）



  - [x] 8.1 实现 VoiceSettings 组件


    - 创建 `src/components/VoiceSettings.tsx`
    - 实现语音输入开关
    - 实现语音输出开关
    - 实现语速调节滑块
    - 实现音调调节滑块
    - 实现语音选择下拉框
    - _需求: 3.1, 3.2, 6.1, 6.2, 6.3_

  - [x] 8.2 实现设置变更处理


    - 连接到 useVoiceChat 的 updateSettings
    - 实现实时预览（调整设置时播放示例）
    - _需求: 6.4, 6.5_

  - [ ]* 8.3 编写 VoiceSettings 的单元测试
    - 测试开关切换
    - 测试滑块调节
    - 测试语音选择
    - 测试设置保存
    - _需求: 3.1, 3.2, 3.3, 3.4, 6.1, 6.2, 6.3, 6.4, 6.5_


- [x] 9. 集成语音功能到 ChatInterface


  - [x] 9.1 在 ChatInterface 中集成 useVoiceChat


    - 导入 useVoiceChat Hook
    - 添加语音相关状态管理
    - 处理浏览器不支持的情况
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [x] 9.2 添加语音输入功能


    - 在输入区域添加 VoiceButton
    - 监听 transcript 变化，自动填充输入框
    - 实现自动发送逻辑（如果启用）
    - _需求: 1.1, 1.4, 7.1_

  - [x] 9.3 添加语音输出功能


    - 监听 messages 变化
    - 当收到 AI 回复且语音输出启用时，自动播放
    - 添加停止播放按钮
    - _需求: 2.1, 2.3, 2.4, 7.2_

  - [x] 9.4 添加 VoiceIndicator 显示


    - 在聊天界面中添加 VoiceIndicator
    - 根据语音状态显示/隐藏
    - _需求: 1.2, 2.2, 4.1, 4.2, 4.3_

  - [x] 9.5 添加语音错误处理


    - 显示语音相关错误
    - 提供重试选项
    - 实现错误恢复逻辑
    - _需求: 1.5, 4.4, 5.1, 5.2, 5.3, 5.4, 5.5_

  - [x] 9.6 添加设置入口（可选）


    - 在 Header 或输入区域添加设置按钮
    - 实现设置面板的显示/隐藏
    - _需求: 3.1, 3.2, 6.1, 6.2, 6.3_

  - [ ]* 9.7 编写 ChatInterface 集成的属性测试
    - **属性 14: 输入方式一致性**
    - **验证: 需求 7.1**

  - [ ]* 9.8 编写 ChatInterface 集成的属性测试
    - **属性 15: 双重输出一致性**
    - **验证: 需求 7.2**

  - [ ]* 9.9 编写 ChatInterface 集成的属性测试
    - **属性 16: 功能隔离性**
    - **验证: 需求 7.5**

  - [ ]* 9.10 编写 ChatInterface 集成的属性测试
    - **属性 5: 错误显示一致性**
    - **验证: 需求 1.5, 4.4, 5.1, 5.2, 5.3, 5.4, 5.5**

  - [ ]* 9.11 编写 ChatInterface 集成的单元测试
    - 测试语音输入集成
    - 测试语音输出集成
    - 测试错误处理
    - 测试设置面板
    - _需求: 1.1, 1.4, 2.1, 2.3, 2.4, 7.1, 7.2_

- [ ] 10. 检查点 - 确保所有集成测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 11. 优化和完善





  - [x] 11.1 性能优化


    - 实现防抖避免频繁操作
    - 优化长文本分段播放
    - 清理事件监听器防止内存泄漏
    - _需求: 7.5_

  - [x] 11.2 可访问性改进


    - 为语音按钮添加 aria-label
    - 添加键盘支持（Tab、Enter、Space）
    - 使用 aria-live 通知状态变化
    - _需求: 4.1, 4.2, 4.3, 4.4_

  - [x] 11.3 用户体验优化


    - 添加音量指示器（可选）
    - 优化动画效果
    - 改进错误提示文案
    - _需求: 1.2, 1.5, 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ]* 11.4 编写端到端集成测试
    - 测试完整的语音输入流程
    - 测试完整的语音输出流程
    - 测试设置变更流程
    - 测试错误恢复流程
    - _需求: 所有需求_

- [ ] 12. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
